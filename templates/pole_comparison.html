{% extends "base.html" %}

{% block title %}Pole Comparison - CPS Energy Tools{% endblock %}

{% block content %}
<div class="container my-4">
    <h1 class="mb-4">
        <i class="fas fa-balance-scale text-primary me-2"></i> Pole Comparison
    </h1>

    <!-- Upload / Options Form -->
    <form method="post" enctype="multipart/form-data" class="card mb-4 p-4">
        <div class="row g-3">
            <div class="col-md-5">
                <label class="form-label fw-semibold">Katapult Excel File</label>
                <input type="file" class="form-control" name="katapult_file" accept=".xlsx,.xls" required>
            </div>
            <div class="col-md-5">
                <label class="form-label fw-semibold">SPIDAcalc JSON File</label>
                <input type="file" class="form-control" name="spida_file" accept=".json" required>
            </div>
            <div class="col-md-2">
                <label class="form-label fw-semibold">Threshold (%)</label>
                <input type="number" step="0.1" min="0" class="form-control" name="threshold" value="{{ threshold or 5 }}">
            </div>
            <div class="col-12 text-end">
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-play me-2"></i>Process
                </button>
            </div>
        </div>
    </form>

    {% if summary %}
    <!-- Summary Banner -->
    <div class="alert alert-info d-flex justify-content-between align-items-center">
        <div>
            Compared {{ summary.total_poles }} poles &nbsp;|&nbsp;
            <strong>{{ summary.poles_with_issues }}</strong> issues flagged &nbsp;|&nbsp;
            <strong>{{ summary.verification_errors }}</strong> verification errors &nbsp;|&nbsp;
            Threshold: {{ summary.threshold }}%
        </div>
        <div>
            <a href="{{ url_for('pole_comparison_download') }}" class="btn btn-success btn-sm me-2">
                <i class="fas fa-download me-1"></i>Download CSV (All)
            </a>
            <a href="{{ url_for('pole_comparison_download', issues_only='true') }}" class="btn btn-warning btn-sm">
                <i class="fas fa-exclamation-triangle me-1"></i>Download Issues Only
            </a>
        </div>
    </div>

    <!-- Tabs -->
    <h2 id="resultsHeader" class="mt-5">Results</h2>
    <!-- Results Card -->
    <div class="card shadow-sm mt-3">
        <div class="card-header">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <ul class="nav nav-pills" id="resultsTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="all-tab" data-bs-toggle="tab" data-bs-target="#all" type="button" role="tab">
                                All Poles ({{ all_rows|length }})
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="issues-tab" data-bs-toggle="tab" data-bs-target="#issues" type="button" role="tab">
                                Issues Found ({{ issue_rows|length }})
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="verif-tab" data-bs-toggle="tab" data-bs-target="#verification" type="button" role="tab">
                                Verification Issues ({{ summary.verification_errors }})
                            </button>
                        </li>
                    </ul>
                </div>
                <div class="input-group" style="max-width: 250px;">
                    <span class="input-group-text"><i class="fas fa-search"></i></span>
                    <input type="text" id="globalSearch" class="form-control form-control-sm" placeholder="Search poles...">
                </div>
                <div>
                    <a href="{{ url_for('pole_comparison_download') }}" class="btn btn-outline-secondary btn-sm me-2">Export CSV</a>
                </div>
            </div> <!-- /controls flex -->
        </div> <!-- /card-header -->
        <div class="card-body p-0">
            <div class="tab-content p-3" id="resultsTabsContent">
                <!-- All Rows -->
                <div class="tab-pane fade show active" id="all" role="tabpanel">
                    {% with rows=all_rows, table_id='tblAll', threshold=threshold %}
                        {% include 'partials/pole_comparison_table.html' %}
                    {% endwith %}
                    <small class="text-muted d-block mt-2">Showing {{ all_rows|length }} of {{ summary.total_poles }} poles</small>
                </div>
                <!-- Issues Only -->
                <div class="tab-pane fade" id="issues" role="tabpanel">
                    {% with rows=issue_rows, table_id='tblIssues', threshold=threshold %}
                        {% include 'partials/pole_comparison_table.html' %}
                    {% endwith %}
                    <small class="text-muted d-block mt-2">Showing {{ issue_rows|length }} issues</small>
                </div>
                <!-- Verification -->
                <div class="tab-pane fade" id="verification" role="tabpanel">
                    <h5>Missing in SPIDA ({{ verification.missing_in_spida|length }})</h5>
                    <p>{{ verification.missing_in_spida|join(', ') or 'None' }}</p>

                    <h5>Missing in Katapult ({{ verification.missing_in_katapult|length }})</h5>
                    <p>{{ verification.missing_in_katapult|join(', ') or 'None' }}</p>

                    <h5>Duplicates in SPIDA ({{ verification.duplicates_in_spida|length }})</h5>
                    <p>{{ verification.duplicates_in_spida|join(', ') or 'None' }}</p>

                    <h5>Duplicates in Katapult ({{ verification.duplicates_in_katapult|length }})</h5>
                    <p>{{ verification.duplicates_in_katapult|join(', ') or 'None' }}</p>

                    <h5>Formatting Issues ({{ verification.formatting_issues|length }})</h5>
                    <ul>
                    {% for issue in verification.formatting_issues %}
                        <li>{{ issue.poleId }} â€“ {{ issue.issue }}</li>
                    {% else %}
                        <li>No formatting issues detected.</li>
                    {% endfor %}
                    </ul>
                </div>
            </div> <!-- /tab-content -->
        </div> <!-- /card-body -->
    </div> <!-- /card -->
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<script src="{{ url_for('static', filename='js/pole_comparison_results.js') }}"></script>
{% endblock %} 